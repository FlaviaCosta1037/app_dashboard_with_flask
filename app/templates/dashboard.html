{% extends "base.html" %}
{% block content %}

<!-- HEADER -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-0">{{ project.title }}</h2>
    <small class="text-muted">Dashboard</small>
  </div>

  <a href="{{ url_for('new_visual') }}" class="btn btn-primary">
    Novo gr√°fico
  </a>
</div>

<hr>

{% if project.charts|length == 0 %}
  <p class="text-muted">Nenhum gr√°fico criado ainda.</p>
{% endif %}

<!-- GRID -->
<div class="dashboard-grid">
  {% for chart in project.charts %}
  <div class="chart-wrapper chart-{{ chart.type }}">
    
    <div class="chart-header">
      <span class="chart-title">{{ chart.type|capitalize }}</span>

      <button
        class="delete-chart-btn"
        data-chart-id="{{ chart.id }}"
        onclick="openDeleteModal(this)"
      >
        üóëÔ∏è
      </button>
    </div>

    <canvas id="chart-{{ chart.id }}"></canvas>
  </div>
  {% endfor %}
</div>

<!-- MODAL DELETE -->
<div class="modal-backdrop" id="deleteModal">
  <div class="modal-box">
    <h4>Excluir gr√°fico</h4>
    <p>Tem certeza que deseja excluir este gr√°fico?</p>

    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancelar</button>

      <form id="deleteForm" method="POST">
        <button type="submit" class="btn btn-danger">Excluir</button>
      </form>
    </div>
  </div>
</div>

<!-- SCRIPT DOS GR√ÅFICOS -->
<script>
{% for chart in project.charts %}
fetch("/chart/data/{{ chart.id }}")
  .then(res => res.json())
  .then(data => {
    const canvas = document.getElementById("chart-{{ chart.id }}");

    new Chart(canvas, {
      type: data.type,
      data: {
        labels: data.labels,
        datasets: [{
          label: data.y,
          data: data.values
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false, // üî• EVITA ESPA√áOS FANTASMAS
        plugins: {
          legend: {
            position: "bottom"
          }
        }
      }
    });
  });
{% endfor %}

/* ===== MODAL DELETE ===== */
function openDeleteModal(button) {
  const chartId = button.dataset.chartId;
  const form = document.getElementById("deleteForm");
  form.action = `/visual/delete/${chartId}`;
  document.getElementById("deleteModal").classList.add("active");
}

function closeDeleteModal() {
  document.getElementById("deleteModal").classList.remove("active");
}
</script>

{% endblock %}
