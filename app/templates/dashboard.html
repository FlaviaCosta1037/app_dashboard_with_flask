{% extends "base.html" %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-0">{{ project.title }}</h2>
      <small class="text-muted">Dashboard</small>
    </div>
  
    <a href="{{ url_for('new_visual') }}" class="btn btn-primary">
      <i class="bi bi-plus-lg"></i> Novo gr√°fico
    </a>
  </div>
<hr>

{% if project.charts|length == 0 %}
  <p>Nenhum gr√°fico criado ainda.</p>
{% endif %}

<div class="charts-grid">
  {% for chart in project.charts %}
    <div class="chart-card">

      <!-- bot√£o delete -->
      <button
        class="delete-btn"
        data-chart-id="{{ chart.id }}"
        onclick="openDeleteModal(this)"
      >
        üóëÔ∏è
      </button>

      <canvas id="chart-{{ chart.id }}"></canvas>

    </div>
  {% endfor %}
</div>

<!-- MODAL DE CONFIRMA√á√ÉO (√öNICO) -->
<div class="modal-backdrop" id="deleteModal">
  <div class="modal-box">
    <h3>Excluir gr√°fico</h3>
    <p>Tem certeza que deseja excluir este gr√°fico?</p>

    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeDeleteModal()">Cancelar</button>

      <form id="deleteForm" method="POST">
        <button type="submit" class="btn-danger">Excluir</button>
      </form>
    </div>
  </div>
</div>

<!-- SCRIPT DOS GR√ÅFICOS -->
<script>
{% for chart in project.charts %}
fetch("/chart/data/{{ chart.id }}")
  .then(res => res.json())
  .then(data => {
    new Chart(
      document.getElementById("chart-{{ chart.id }}"),
      {
        type: data.type,
        data: {
          labels: data.labels,
          datasets: [{
            label: data.y,
            data: data.values
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true
        }
      }
    );
  });
{% endfor %}

/* ===== MODAL DELETE ===== */
function openDeleteModal(button) {
  const chartId = button.dataset.chartId;
  const form = document.getElementById("deleteForm");
  form.action = `/visual/delete/${chartId}`;
  document.getElementById("deleteModal").classList.add("active");
}

function closeDeleteModal() {
  document.getElementById("deleteModal").classList.remove("active");
}
</script>

{% endblock %}
